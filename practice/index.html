<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°°êµ¬ ê¸°ëŠ¥ í–¥ìƒë„ Check!</title>
  <script>
    window.__VB_GATE_CONFIG__ = {
      configPath: "../firebase.config.js?v=20260216-2",
      redirectOnLock: true,
      redirectTo: "../index.html"
    };
  </script>
  <script src="../gate.js?v=20260216-2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:#f5f6f8;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .title{font-size:30px;font-weight:950;margin:6px 0 14px;}

    .card{background:#fff;border:1px solid #e8e8e8;border-radius:14px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .sp{justify-content:space-between;}
    .btn{
      padding:10px 12px;border:1px solid #ddd;background:#fff;border-radius:12px;
      font-weight:900;cursor:pointer;
    }
    .btn.active{border-color:#111;}
    .btn.primary{border-color:#111;}
    .hint{color:#666;font-size:12px;margin-top:8px;line-height:1.4;}
    .muted{color:#666;font-size:12px;}

    /* í•™êµ/í•™ë…„/ë°˜ ì…ë ¥ */
    .schoolLine{
      margin-top:12px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      font-size:20px;
      font-weight:950;
    }
    .schoolLine input{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;
      font-weight:900;text-align:center;
      background:#fff;
      font-size: 20px;
    }
    #schoolName{ width:160px; }
    #gradeInput{ width:80px; }
    #classInput{ width:80px; }

    /* í•™ìƒ ê·¸ë¦¬ë“œ */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(3, minmax(0, 1fr));} }
    @media (max-width: 560px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .stuBtn{
      border:1px solid #e6e6e6;background:#fff;border-radius:14px;
      padding:10px;cursor:pointer;min-height:74px;
      display:flex;flex-direction:column;justify-content:center;gap:6px;
      text-align:left;
    }
    .stuTop{display:flex;justify-content:space-between;align-items:center;gap:10px;width:100%;}
    .stuNum{font-weight:950;font-size:16px;}
    .stuName{
      font-weight:900;font-size:15px;color:#111;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .mini{font-size:12px;color:#666;}
    .badge{
      font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;
      border:1px solid #e5e5e5;color:#333;background:#fafafa;white-space:nowrap;
    }
    .badge.ok{border-color:#cce7d3;background:#effaf2;color:#1b6b2a;}

    /* í•­ëª©ë³„ ì…ë ¥(í…Œì´ë¸”) */
    .formRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px;}
    input[type="date"], input[type="number"], input[type="text"]{
      padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-weight:800;
    }
    input[type="number"]{width:90px;}
    .tableWrap{margin-top:12px;border:1px solid #eee;border-radius:14px;overflow:auto;}
    table{border-collapse:collapse;width:100%;min-width:900px;}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center;}
    th{position:sticky;top:0;background:#fafafa;z-index:1;}
    td.left{text-align:left;}
    .saved{font-size:12px;color:#1b6b2a;font-weight:900;}

    /* ëª¨ë‹¬ */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;}
    .backdrop.open{display:flex;}
    .modal{width:min(980px, 96vw);background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;}
    .mHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .mTitle{font-size:18px;font-weight:950;}
    .mBtns{display:flex;gap:8px;flex-wrap:wrap;}

    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:10px;}
    @media(max-width: 900px){ .twoCol{grid-template-columns: 1fr;} }
    .sectionTitle{margin:0 0 8px;font-weight:950;}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;}
    .kpi{border:1px solid #eee;border-radius:14px;padding:10px;min-width:190px;background:#fafafa;}
    .kpi b{font-size:20px;}

    .metricRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .metricBtn{padding:10px 12px;border:1px solid #ddd;background:#fff;border-radius:12px;font-weight:900;cursor:pointer;}
    .metricBtn.active{border-color:#111;}
    canvas{width:100%;height:260px;border:1px solid #eee;border-radius:14px;background:#fff;}

    .modeBar{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    :root{
      --bg: #f5f8ff;
      --panel: #ffffff;
      --panel2: #f7fbff;
      --border: #dbe7ff;

      --text: #0f172a;
      --muted: #64748b;

      --blue: #2563eb;
      --cyan: #06b6d4;

      --shadow: 0 10px 26px rgba(15, 23, 42, .08);
    }

    /* ë°°ê²½ */
    body{
      background:
        radial-gradient(1000px 520px at 18% 0%, rgba(37,99,235,.16), transparent 55%),
        radial-gradient(900px 520px at 80% 10%, rgba(6,182,212,.12), transparent 55%),
        var(--bg);
      color: var(--text);
      font-family: "Jua", system-ui, -apple-system, "Noto Sans KR", sans-serif;
    }

    /* ì»¨í…Œì´ë„ˆ */
    .wrap{ max-width: 1200px; }

    /* íƒ€ì´í‹€ */
    .title{
      color: var(--text);
      text-shadow: 0 2px 14px rgba(37,99,235,.12);
      text-align:center;
    }

    /* ì¹´ë“œ */
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* ì•ˆë‚´ í…ìŠ¤íŠ¸ */
    .hint, .muted, .mini{ color: var(--muted) !important; }

    /* ì…ë ¥ */
    input[type="text"], input[type="date"], input[type="number"]{
      background: #fff;
      border: 1px solid #cfe0ff;
      color: var(--text);
      font-family: "Jua", system-ui, -apple-system, "Noto Sans KR", sans-serif;
    }
    input::placeholder{ color: rgba(100,116,139,.65); }
    input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.16);
      outline: none;
    }

    /* ë²„íŠ¼ ê¸°ë³¸ */
    .btn{
      background: #ffffff;
      border: 1px solid #cfe0ff;
      color: var(--text);
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      font-family: "Jua", system-ui, -apple-system, "Noto Sans KR", sans-serif;
    }
    .btn:hover{ filter: brightness(1.03); box-shadow: 0 10px 24px rgba(15,23,42,.08); }
    .btn:active{ transform: scale(.985); }

    /* ì„ íƒëœ íƒ­(í•™ìƒë³„/í•­ëª©ë³„) */
    .btn.active{
      border-color: rgba(37,99,235,.60);
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(6,182,212,.10));
    }

    /* ì£¼ìš” ë²„íŠ¼(ë¶ˆëŸ¬ì˜¤ê¸°) */
    .btn.primary{
      border-color: rgba(37,99,235,.65);
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(6,182,212,.72));
      color: #ffffff;
    }

    /* í•™ìƒ ë²„íŠ¼ */
    .stuBtn{
      background: #ffffff;
      border: 1px solid #e1ecff;
      box-shadow: 0 10px 26px rgba(15,23,42,.07);
    }
    .stuBtn:hover{ filter: brightness(1.02); }
    .stuBtn:active{ transform: scale(.985); }

    /* í•™ìƒ ì´ë¦„ ë°•ìŠ¤(ë°•ìŠ¤ ìì²´ ê°•ì¡°) */
    .stuName{
      color: var(--text);
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(6,182,212,.12));
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(37,99,235,.18);
      display: block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      margin-top: 6px;
    }

    /* ë°°ì§€ */
    .badge{
      background: rgba(15,23,42,.03);
      border: 1px solid rgba(15,23,42,.08);
      color: rgba(15,23,42,.72);
    }
    .badge.ok{
      background: rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.25);
      color: #166534;
    }

    /* í•­ëª©ë³„ í‘œ */
    .tableWrap{ border: 1px solid #dbe7ff; background: rgba(255,255,255,.75); }
    th{ background: #f1f7ff !important; border-bottom: 1px solid #dbe7ff; color: rgba(15,23,42,.85); }
    td{ border-bottom: 1px solid rgba(219,231,255,.70); }

    /* ëª¨ë‹¬ì€ ê¸°ë³¸ í°íŠ¸(ì£¼ì•„ì²´ X) */
    .modal, .modal *{
      font-family: system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, sans-serif !important;
    }

    .rosterControls{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin: 10px 0 10px;
    }

    /* âœ… ì—¬í•™ìƒ: ë²„íŠ¼ ì „ì²´ëŠ” ê·¸ëŒ€ë¡œ, "ì´ë¦„"ë§Œ ë¶‰ì€ í†¤ */
    .stuBtn.female .stuName{
      background: linear-gradient(180deg, #fff1f2, #ffe4e6);
      border: 1px solid #fecdd3;
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      display: block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      margin-top: 6px;
    }

    /* âœ… ë‚¨í•™ìƒ(ê¸°ë³¸): ì´ë¦„ íŒŒë€ í†¤ */
.stuBtn.male .stuName{
  background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(6,182,212,.12));
  border: 1px solid rgba(37,99,235,.18);
  color: var(--text);
}

/* âœ… ì—¬í•™ìƒ: ì´ë¦„ ë¹¨ê°„ í†¤ (ì´ë¯¸ ìˆìœ¼ë©´ ì´ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì“°ê¸°) */
.stuBtn.female .stuName{
  background: linear-gradient(180deg, #fff1f2, #ffe4e6);
  border: 1px solid #fecdd3;
  color: var(--text);
}

    /* âœ… ì„±ë³„ í‘œì‹œ ì¹©(ë‚¨/ì—¬) */
    .genderTag{
      margin-top:6px;
      font-size:12px;
      font-weight:900;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #cfe0ff;
      background:#f1f7ff;
      color:#1e3a8a;
      display:inline-block;
    }
    .stuBtn.female .genderTag{
      border-color:#fecdd3;
      background:#fff1f2;
      color:#9f1239;
    }

    /* í•™ìƒ ë²„íŠ¼ ì•ˆ ì „ì²´ ê°€ìš´ë° ì •ë ¬(ìš”ì²­ ë°˜ì˜) */
    .stuBtn{
      text-align:center !important;
      align-items:center;
    }
    .stuTop{ width:100%; }

    /* ================================
   TOP10 í™”ë©´ ë””ìì¸
================================ */
.top10Head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  padding:6px 4px 10px;
}

.top10Sub{
  font-size:13px;
  font-weight:900;
  color:#475569;
  flex:1;
  text-align:center;
  opacity:.9;
}

.top10Grid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:12px;
}
@media (max-width: 980px){
  .top10Grid{ grid-template-columns: 1fr; }
  .top10Sub{ text-align:left; }
}

.rankCard{
  border:1px solid rgba(219,231,255,.9);
  border-radius:16px;
  padding:12px;
  background: linear-gradient(180deg,#ffffff,#f7fbff);
  box-shadow: 0 12px 26px rgba(15,23,42,.08);
}

.rankCard.under{
  background: linear-gradient(180deg, rgba(37,99,235,.10), #ffffff);
  border-color: rgba(37,99,235,.25);
}
.rankCard.over{
  background: linear-gradient(180deg, rgba(34,197,94,.10), #ffffff);
  border-color: rgba(34,197,94,.25);
}
.rankCard.serve{
  background: linear-gradient(180deg, rgba(168,85,247,.10), #ffffff);
  border-color: rgba(168,85,247,.25);
}

.rankTitle{
  font-size:18px;
  font-weight:950;
  text-align:center;
  padding:6px 0 10px;
}

.rankList{
  list-style:none;
  padding:0;
  margin:0;
}

.rankItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 10px;
  margin:8px 0;
  border-radius:14px;
  background: rgba(255,255,255,.85);
  border: 1px solid rgba(15,23,42,.06);
}

.rankLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}

.rankNum{
  width:42px;
  height:42px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:950;
  font-size:18px;
  background: rgba(15,23,42,.06);
}

.rankName{
  font-weight:950;
  font-size:22px;   /* âœ… ì´ë¦„ í¬ê²Œ */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.rankCount{
  font-weight:950;
  font-size:26px;   /* âœ… ê°œìˆ˜ í¬ê²Œ */
  white-space:nowrap;
}

.rankItem.r1 .rankNum{ background: linear-gradient(135deg,#f59e0b,#fbbf24); }
.rankItem.r2 .rankNum{ background: linear-gradient(135deg,#94a3b8,#e2e8f0); }
.rankItem.r3 .rankNum{ background: linear-gradient(135deg,#fb7185,#fecdd3); }

/* =========================
   TOP5 (ë‚¨/ì—¬ ë¶„ë¦¬) UI
========================= */
.metricBlock{ margin-top:16px; }
.metricTitle{
  font-size:22px;
  font-weight:950;
  text-align:center;
  margin:10px 0 12px;
}

.twoGender{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}
@media (max-width: 900px){
  .twoGender{ grid-template-columns: 1fr; }
}

.topBox{
  border:1px solid var(--border, #dbe7ff);
  border-radius:18px;
  padding:12px;
  box-shadow: var(--shadow, 0 10px 26px rgba(15, 23, 42, .08));
  background:#fff;
}

.topBox.male{
  background: linear-gradient(180deg, rgba(37,99,235,.14), rgba(255,255,255,.92));
}
.topBox.female{
  background: linear-gradient(180deg, rgba(244,63,94,.14), rgba(255,255,255,.92));
}

.topHead{
  font-size:18px;
  font-weight:950;
  text-align:center;
  padding:6px 0 10px;
}

.topRow{
  display:grid;
  grid-template-columns: 64px 1fr 86px;
  align-items:center;
  gap:10px;
  padding:12px 10px;
  border-top:1px dashed rgba(15,23,42,.14);
}
.topRow:first-of-type{ border-top:none; }

.rank{
  font-weight:950;
  font-size:22px;
  text-align:center;
}
.nm{
  font-weight:950;
  font-size:20px;
}
.val{
  font-weight:950;
  font-size:26px;
  text-align:right;
}

.topEmpty{
  text-align:center;
  color: var(--muted, #64748b);
  padding:14px 0;
  font-weight:900;
}

.tieHint{
  margin-top:10px;
  text-align:center;
  font-size:12px;
  color: var(--muted, #64748b);
  font-weight:900;
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">ë°°êµ¬ ê¸°ëŠ¥ í–¥ìƒë„ Check!</div>
    <div id="slotBadge" style="font-size:12px;opacity:.6;margin:6px 0;"></div>

    <!-- ìƒë‹¨ ë°•ìŠ¤(ì˜¤ë¥¸ìª½ ìƒë‹¨ ë²„íŠ¼ 2ê°œë§Œ ì¡´ì¬) -->
    <div class="card">
      <div class="row sp">
        <div></div>
        <div class="row">
          <button class="btn primary" id="importRosterBtn" type="button">í•™ìƒ ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°(CSV)</button>
          <button class="btn" id="resetAllBtn" type="button">ì „ì²´ ì´ˆê¸°í™”</button>
          <input id="rosterFile" type="file" accept=".csv,text/csv" hidden />
        </div>
      </div>

      <div class="schoolLine">
        <input id="schoolName" type="text" placeholder="(   )" />
        <span>ì¤‘í•™êµ</span>
        <input id="gradeInput" type="text" placeholder="( )" />
        <span>í•™ë…„</span>
        <input id="classInput" type="text" placeholder="( )" />
        <span>ë°˜</span>
      </div>

      <div class="hint">â€» í•™êµ/í•™ë…„/ë°˜ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- í•™ìƒë³„/í•­ëª©ë³„ ë²„íŠ¼ -->
    <div class="modeBar">
      <button class="btn" id="modeStudentBtn" type="button">ê°œì¸ë³„</button>
      <button class="btn" id="modeItemBtn" type="button">ğŸ†TOP5ğŸ†</button>
    </div>

    <!-- í•™ìƒë³„ í™”ë©´ -->
    <section class="card" id="studentSection" style="margin-top:12px;">
      <div class="sectionTitle">í•™ìƒ - ë²„íŠ¼ í´ë¦­ â†’ ë‚ ì§œë³„ ê¸°ë¡ ì…ë ¥ / ê·¸ë˜í”„ ë³´ê¸°</div>

      <div class="rosterControls">
        <button class="btn" id="addStudentBtn" type="button">+ í•™ìƒ ì¶”ê°€</button>
        <button class="btn" id="removeStudentBtn" type="button">- í•™ìƒ ì‚­ì œ</button>
      </div>

      <div class="grid" id="studentsGrid"></div>

      <div class="hint">
        âœ… ê·¸ë˜í”„/ë°°ì§€/ìµœê³ ê¸°ë¡ì€ <b>í•™ìƒë³„ íŒì—…ì—ì„œ ì €ì¥í•œ ê¸°ë¡</b>ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
        âœ… CSV ì˜ˆì‹œ(ê¶Œì¥): <b>number,name,gender</b> (gender: M/F ë˜ëŠ” ë‚¨/ì—¬)<br/>
        1,ê¹€ì² ìˆ˜,M<br/>
        2,ì´ì˜í¬,F
      </div>
    </section>

<section class="card" id="itemSection" style="margin-top:12px; display:none;">
  <div class="sectionTitle" style="text-align:center;font-size:22px;font-weight:950;">
    ğŸ† TOP5
  </div>

  <!-- TOP5 ê²°ê³¼ê°€ ì—¬ê¸°ì— ê·¸ë ¤ì§ -->
  <div id="top10Mount"></div>

  <div class="hint" style="text-align:center;margin-top:10px;">
    â€» ë‚¨í•™ìƒ/ì—¬í•™ìƒì„ ë”°ë¡œ ê³„ì‚°í•˜ë©°, 5ë“±ê³¼ ë™ì ìëŠ” ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤.
  </div>
</section>
  </div>

  <!-- í•™ìƒ ëª¨ë‹¬ -->
  <div class="backdrop" id="stuBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="stuTitle">í•™ìƒ</div>
        <div class="mBtns">
          <button class="btn" id="editNameBtn" type="button">ì´ë¦„ ìˆ˜ì •</button>
          <button class="btn" id="closeStuBtn" type="button">ë‹«ê¸°</button>
        </div>
      </div>

      <div class="twoCol">
        <!-- LEFT -->
        <div class="card" style="border-radius:16px;">
          <div class="sectionTitle">ê·¸ë˜í”„ í•­ëª© ì„ íƒ</div>
          <div class="metricRow">
            <button class="metricBtn active" data-metric="under" type="button">ì–¸ë”</button>
            <button class="metricBtn" data-metric="over" type="button">ì˜¤ë²„</button>
            <button class="metricBtn" data-metric="serve" type="button">ì„œë¸Œ</button>
          </div>

          <div class="sectionTitle" style="margin-top:12px;">ìš”ì•½(ìµœê³ ê¸°ë¡ ì¤‘ì‹¬)</div>
          <div class="kpiRow" id="kpiRow"></div>

          <div class="sectionTitle" style="margin-top:12px;">ë‚ ì§œë³„ ê¸°ë¡ ì…ë ¥</div>
          <div class="formRow" style="margin-top:6px;">
            <span class="muted">ë‚ ì§œ</span>
            <input id="stuDate" type="date" />
          </div>

          <div class="stuEntryGrid">
  <div class="stuField">
    <div class="label">ì–¸ë”</div>
    <input id="stuUnder" type="number" min="0" step="1" value="0">
  </div>

  <div class="stuField">
    <div class="label">ì˜¤ë²„</div>
    <input id="stuOver" type="number" min="0" step="1" value="0">
  </div>

  <!-- âœ… ì„œë¸ŒëŠ” ì–¸ë” ë°‘(ì™¼ìª½ ì¹¸)ìœ¼ë¡œ ë‚´ë ¤ê° -->
  <div class="stuField serve">
    <div class="label">ì„œë¸Œ</div>
    <input id="stuServe" type="number" min="0" step="1" value="0">
  </div>
</div>


          <div class="formRow" style="margin-top:6px; justify-content:flex-end;">
            <button class="btn primary" id="stuSaveBtn" type="button">ì €ì¥</button>
            <button class="btn" id="stuDeleteBtn" type="button">ì‚­ì œ</button>
          </div>

          <div class="hint">â€» ì–¸ë”/ì˜¤ë²„/ì„œë¸Œê°€ ëª¨ë‘ 0ì´ë©´ â€œê¸°ë¡ ì—†ìŒâ€ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
        </div>

        <!-- RIGHT -->
        <div class="card" style="border-radius:16px;">
          <div class="sectionTitle">í–¥ìƒ ê·¸ë˜í”„</div>
          <canvas id="chartCanvas" width="900" height="320"></canvas>
          <div class="hint" id="chartHint"></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="../firebase.config.js?v=20260216-2"></script>
<script>
/* =========================================================
   SLOT/KEY
========================================================= */
const SLOT = new URLSearchParams(location.search).get("slot") || "default";
const KEY  = `vb_under_over_serve_v1__${SLOT}`;
const STORAGE_PREFIX = "vb_under_over_serve_v1__";
const PRACTICE_DOC_ID = `practice_slot_${SLOT}`;
const PRACTICE_CLIENT_KEY = `${KEY}__client_id`;

const PRACTICE_CLIENT_ID = (() => {
  const saved = localStorage.getItem(PRACTICE_CLIENT_KEY);
  if (saved) return saved;
  const next = (window.crypto && crypto.randomUUID)
    ? crypto.randomUUID()
    : `practice-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  localStorage.setItem(PRACTICE_CLIENT_KEY, next);
  return next;
})();

let practiceCloudRef = null;
let practiceStatesRef = null;
let practiceCloudUnsub = null;
let practiceCloudSaveTimer = null;
let practiceApplyingRemote = false;

function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
  schedulePracticeCloudSave();
}
function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }

function hasFirebaseConfig(cfg){
  if (!cfg || typeof cfg !== "object") return false;
  const need = ["apiKey", "authDomain", "projectId", "appId"];
  return need.every(k => typeof cfg[k] === "string" && cfg[k].trim() !== "");
}

function canWriteCloud(){
  return window.__VB_GATE_IS_OPEN__ === true;
}

function initPracticeCloudRef(){
  if (!window.firebase || !hasFirebaseConfig(window.FB_CONFIG)) return null;
  try{
    if (!firebase.apps.length) firebase.initializeApp(window.FB_CONFIG);
    const db = firebase.firestore();
    const classId = String(window.CLASS_ID || "public-class-1").trim() || "public-class-1";
    practiceStatesRef = db.collection("classes").doc(classId).collection("states");
    return practiceStatesRef.doc(PRACTICE_DOC_ID);
  }catch(err){
    console.warn("[firebase] practice cloud init failed:", err);
    return null;
  }
}

function snapshotPracticeState(){
  return {
    mode: state.mode,
    roster: Array.isArray(state.roster) ? state.roster : [],
    studentRecordsByDate: state.studentRecordsByDate || {},
    itemRecordsByDate: state.itemRecordsByDate || {},
    lastMetric: state.lastMetric || "under",
    meta: state.meta || { school:"", grade:"", className:"" }
  };
}

function schedulePracticeCloudSave(){
  if (!canWriteCloud()) return;
  if (!practiceCloudRef || practiceApplyingRemote || typeof state === "undefined") return;
  if (practiceCloudSaveTimer) clearTimeout(practiceCloudSaveTimer);
  practiceCloudSaveTimer = setTimeout(() => { void pushPracticeCloud(); }, 250);
}

async function pushPracticeCloud(){
  if (!canWriteCloud()) return;
  if (!practiceCloudRef || practiceApplyingRemote || typeof state === "undefined") return;
  try{
    const payload = JSON.parse(JSON.stringify(snapshotPracticeState()));
    await practiceCloudRef.set({
      state: payload,
      slot: SLOT,
      updatedBy: PRACTICE_CLIENT_ID,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  }catch(err){
    console.warn("[firebase] practice cloud save failed:", err);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function makeRoster30(){
  return Array.from({length:30}, (_,i)=>({
    number: i+1,
    name: `í•™ìƒ${i+1}`,
    gender: "M" // ê¸°ë³¸ ë‚¨(M), ì—¬ëŠ” F
  }));
}

function todayLocalYYYYMMDD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/* =========================================================
   í•™ìƒë³„ ê¸°ë¡(studentRecordsByDate) í—¬í¼
========================================================= */
function getStudentRec(date, num){
  const day = state.studentRecordsByDate?.[date];
  return day ? day[String(num)] : null;
}

function setStudentRec(date, num, under, over, serve){
  const u = Math.max(0, Number(under||0));
  const o = Math.max(0, Number(over||0));
  const s = Math.max(0, Number(serve||0));

  // 0,0,0ì´ë©´ ê¸°ë¡ ì—†ìŒ â†’ ì‚­ì œ
  if (u===0 && o===0 && s===0){
    deleteStudentRec(date, num);
    return;
  }
  if (!state.studentRecordsByDate[date]) state.studentRecordsByDate[date] = {};
  state.studentRecordsByDate[date][String(num)] = { under:u, over:o, serve:s };
}

function deleteStudentRec(date, num){
  const day = state.studentRecordsByDate?.[date];
  if (!day) return;
  delete day[String(num)];
  if (Object.keys(day).length === 0) delete state.studentRecordsByDate[date];
}

function getStudentDates(num){
  const n = String(num);
  return Object.keys(state.studentRecordsByDate)
    .filter(date => state.studentRecordsByDate[date]?.[n])
    .sort();
}

function hasAnyStudentRecord(num){
  return getStudentDates(num).length > 0;
}

/* =========================================================
   ìƒíƒœ/ë§ˆì´ê·¸ë ˆì´ì…˜
========================================================= */
const state = load() ?? {
  mode: "student", // "student" | "item"(=TOP5)
  roster: makeRoster30(),

  // âœ… ê·¸ë˜í”„/ë°°ì§€/ìµœê³ ê¸°ë¡ì€ ì´ê²ƒë§Œ ì‚¬ìš©
  studentRecordsByDate: {},

  // âœ… (ë‚¨ê²¨ë‘ê¸°) ì˜ˆì „ í•­ëª©ë³„ ê¸°ë¡ ì €ì¥ì†Œ(ìˆì–´ë„ ë˜ê³  ì—†ì–´ë„ ë¨)
  itemRecordsByDate: {},

  lastMetric: "under",
  meta: { school:"", grade:"", className:"" },
};

function sanitizePracticeState(target){
  if (!target || typeof target !== "object") return target;
  if (!target.meta) target.meta = { school:"", grade:"", className:"" };
  if (!target.studentRecordsByDate) target.studentRecordsByDate = {};
  if (!target.itemRecordsByDate) target.itemRecordsByDate = {};
  if (!Array.isArray(target.roster)) target.roster = makeRoster30();
  target.lastMetric = ["under", "over", "serve"].includes(target.lastMetric) ? target.lastMetric : "under";

  // gender ê¸°ë³¸ê°’ ë³´ì •
  target.roster = target.roster.map(s => ({
    ...s,
    gender: (s.gender === "F" || s.gender === "M") ? s.gender : "M"
  }));

  // ì˜ˆì „ recordsByDateê°€ ìˆìœ¼ë©´ itemRecordsByDateë¡œ ì´ê´€
  if (target.recordsByDate && !target.itemRecordsByDate) target.itemRecordsByDate = target.recordsByDate;
  if (target.recordsByDate) delete target.recordsByDate;
  return target;
}

sanitizePracticeState(state);

save();

/* =========================================================
   DOM
========================================================= */
const slotBadgeEl = document.getElementById("slotBadge");
if (slotBadgeEl) slotBadgeEl.textContent = `ì €ì¥ê³µê°„(slot): ${SLOT}`;

const modeStudentBtn = document.getElementById("modeStudentBtn");
const modeItemBtn    = document.getElementById("modeItemBtn");
const studentSection = document.getElementById("studentSection");
const itemSection    = document.getElementById("itemSection");

const studentsGrid   = document.getElementById("studentsGrid");

const importRosterBtn = document.getElementById("importRosterBtn");
const rosterFile      = document.getElementById("rosterFile");
const resetAllBtn     = document.getElementById("resetAllBtn");

const schoolNameEl = document.getElementById("schoolName");
const gradeEl      = document.getElementById("gradeInput");
const classEl      = document.getElementById("classInput");

const addStudentBtn    = document.getElementById("addStudentBtn");
const removeStudentBtn = document.getElementById("removeStudentBtn");

// TOP5 ë Œë”ë§ ë§ˆìš´íŠ¸/ìƒˆë¡œê³ ì¹¨(ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¬´ì‹œ)
const topMount = document.getElementById("top10Mount");   // ë„ˆê°€ TOP ì„¹ì…˜ì—ì„œ ë§Œë“¤ì—ˆë˜ mount id
const topRefreshBtn = document.getElementById("topRefreshBtn");

// í•™ìƒ ëª¨ë‹¬
const stuBackdrop = document.getElementById("stuBackdrop");
const stuTitle    = document.getElementById("stuTitle");
const closeStuBtn = document.getElementById("closeStuBtn");
const editNameBtn = document.getElementById("editNameBtn");
const metricBtns  = Array.from(document.querySelectorAll(".metricBtn"));
const kpiRow      = document.getElementById("kpiRow");
const chartCanvas = document.getElementById("chartCanvas");
const chartHint   = document.getElementById("chartHint");
const ctx = chartCanvas ? chartCanvas.getContext("2d") : null;

// íŒì—… ì…ë ¥
const stuDateEl   = document.getElementById("stuDate");
const stuUnderEl  = document.getElementById("stuUnder");
const stuOverEl   = document.getElementById("stuOver");
const stuServeEl  = document.getElementById("stuServe");
const stuSaveBtn  = document.getElementById("stuSaveBtn");
const stuDeleteBtn= document.getElementById("stuDeleteBtn");

let currentStudentNumber = null;

function applyRemotePracticeState(raw){
  if (!raw || typeof raw !== "object") return;
  const incoming = sanitizePracticeState(JSON.parse(JSON.stringify(raw)));
  if (!incoming) return;

  practiceApplyingRemote = true;
  try{
    Object.keys(state).forEach(k => delete state[k]);
    Object.assign(state, incoming);
    localStorage.setItem(KEY, JSON.stringify(state));

    if (schoolNameEl) schoolNameEl.value = state.meta.school || "";
    if (gradeEl) gradeEl.value = state.meta.grade || "";
    if (classEl) classEl.value = state.meta.className || "";

    renderGrid();
    setMode(state.mode || "student");

    if (currentStudentNumber != null){
      const exists = Array.isArray(state.roster) && state.roster.some(s => Number(s.number) === Number(currentStudentNumber));
      if (!exists){
        closeStudent();
      }else{
        if (stuTitle) stuTitle.textContent = `#${currentStudentNumber} ${rosterName(currentStudentNumber)}`;
        loadStudentInputsForDate();
        renderStudentModal();
      }
    }
  } finally {
    practiceApplyingRemote = false;
  }
}

async function startPracticeCloudSync(){
  practiceCloudRef = initPracticeCloudRef();
  if (!practiceCloudRef) return;

  try{
    const snap = await practiceCloudRef.get();
    if (snap.exists){
      const remote = snap.data()?.state;
      if (remote) applyRemotePracticeState(remote);
    }else{
      if (canWriteCloud()) schedulePracticeCloudSave();
    }
  }catch(err){
    console.warn("[firebase] practice cloud initial load failed:", err);
  }

  practiceCloudUnsub = practiceCloudRef.onSnapshot((snap) => {
    if (!snap.exists) return;
    const doc = snap.data() || {};
    if (doc.updatedBy && doc.updatedBy === PRACTICE_CLIENT_ID) return;
    if (doc.state) applyRemotePracticeState(doc.state);
  }, (err) => {
    console.warn("[firebase] practice cloud realtime failed:", err);
  });
}

window.addEventListener("vb-gate-open", () => {
  schedulePracticeCloudSave();
});

/* í•™êµ/í•™ë…„/ë°˜ ê°’ ë°˜ì˜ + ì €ì¥ */
if (schoolNameEl) schoolNameEl.value = state.meta.school || "";
if (gradeEl)      gradeEl.value      = state.meta.grade || "";
if (classEl)      classEl.value      = state.meta.className || "";

if (schoolNameEl) schoolNameEl.addEventListener("input", () => { state.meta.school = schoolNameEl.value; save(); });
if (gradeEl)      gradeEl.addEventListener("input", () => { state.meta.grade = gradeEl.value; save(); });
if (classEl)      classEl.addEventListener("input", () => { state.meta.className = classEl.value; save(); });

/* =========================================================
   ëª¨ë“œ ì „í™˜ (í•™ìƒë³„ / TOP5)
========================================================= */
function setMode(mode){
  state.mode = mode;
  save();

  const isStudent = mode === "student";

  if (studentSection) studentSection.style.display = isStudent ? "" : "none";
  if (itemSection)    itemSection.style.display    = isStudent ? "none" : "";

  if (modeStudentBtn) modeStudentBtn.classList.toggle("active", isStudent);
  if (modeItemBtn)    modeItemBtn.classList.toggle("active", !isStudent);

  if (!isStudent) renderTop5AllSlots();
  else renderGrid();
}

// âœ… (ì¤‘ìš”) ì—¬ê¸°ì„œ ë²„íŠ¼ ì´ë²¤íŠ¸ë¥¼ ì—°ê²°í•´ì•¼ í•¨
if (modeStudentBtn) modeStudentBtn.addEventListener("click", ()=>setMode("student"));
if (modeItemBtn)    modeItemBtn.addEventListener("click", ()=>setMode("item"));

/* =========================================================
   í•™ìƒ ê·¸ë¦¬ë“œ ë Œë”
========================================================= */
function renderGrid(){
  if (!studentsGrid) return;

  studentsGrid.innerHTML = state.roster.map(stu => {
    const ok = hasAnyStudentRecord(stu.number);
    const genderClass = (stu.gender === "F") ? "female" : "male";

    return `
      <button class="stuBtn ${genderClass}" data-number="${stu.number}" type="button">
        <div class="stuTop">
          <div class="stuNum">#${stu.number}</div>
          <div>${ok ? `<span class="badge ok">ê¸°ë¡ ìˆìŒ</span>` : `<span class="badge">ë¯¸ê¸°ë¡</span>`}</div>
        </div>

        <div class="stuName">${escapeHtml(stu.name)}</div>

        <div class="genderTag" data-number="${stu.number}" title="ëˆŒëŸ¬ì„œ ì„±ë³„ ë³€ê²½">
          ${stu.gender === "F" ? "ì—¬" : "ë‚¨"}
        </div>
      </button>
    `;
  }).join("");
}

/* âœ… ì„±ë³„ í† ê¸€ + í•™ìƒ ë²„íŠ¼ í´ë¦­ */
if (studentsGrid){
  studentsGrid.addEventListener("click", (e) => {
    const tag = e.target.closest(".genderTag");
    if (tag) {
      e.stopPropagation();
      const num = Number(tag.dataset.number);
      const stu = state.roster.find(x => x.number === num);
      if (!stu) return;
      stu.gender = (stu.gender === "F") ? "M" : "F";
      save();
      renderGrid();
      return;
    }

    const btn = e.target.closest(".stuBtn");
    if (!btn) return;
    const number = Number(btn.dataset.number);
    openStudent(number);
  });
}

/* =========================================================
   í•™ìƒ ëª¨ë‹¬
========================================================= */
function rosterName(number){
  return state.roster.find(s=>s.number===number)?.name ?? `í•™ìƒ${number}`;
}
function metricLabel(m){
  if (m==="under") return "ì–¸ë”";
  if (m==="over")  return "ì˜¤ë²„";
  return "ì„œë¸Œ";
}

function openStudent(number){
  currentStudentNumber = number;
  if (stuTitle) stuTitle.textContent = `#${number} ${rosterName(number)}`;

  metricBtns.forEach(b => b.classList.toggle("active", b.dataset.metric === state.lastMetric));

  if (stuDateEl) stuDateEl.value = todayLocalYYYYMMDD();
  loadStudentInputsForDate();

  renderStudentModal();

  if (stuBackdrop){
    stuBackdrop.classList.add("open");
    stuBackdrop.setAttribute("aria-hidden","false");
  }
}

function closeStudent(){
  if (stuBackdrop){
    stuBackdrop.classList.remove("open");
    stuBackdrop.setAttribute("aria-hidden","true");
  }
  currentStudentNumber = null;
}

if (closeStuBtn) closeStuBtn.addEventListener("click", closeStudent);
if (stuBackdrop){
  stuBackdrop.addEventListener("click", (e)=>{ if (e.target === stuBackdrop) closeStudent(); });
}

if (editNameBtn){
  editNameBtn.addEventListener("click", ()=>{
    if (currentStudentNumber == null) return;
    const cur = rosterName(currentStudentNumber);
    const next = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", cur);
    if (next == null) return;
    const name = String(next).trim();
    if (!name) return;

    const stu = state.roster.find(s=>s.number===currentStudentNumber);
    if (stu) stu.name = name;

    save();
    if (stuTitle) stuTitle.textContent = `#${currentStudentNumber} ${rosterName(currentStudentNumber)}`;
    renderGrid();
  });
}

metricBtns.forEach(b=>{
  b.addEventListener("click", ()=>{
    metricBtns.forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    state.lastMetric = b.dataset.metric;
    save();
    renderStudentModal();
  });
});

/* ---- íŒì—… ì…ë ¥ ---- */
function loadStudentInputsForDate(){
  if (currentStudentNumber == null) return;
  if (!stuDateEl || !stuUnderEl || !stuOverEl || !stuServeEl) return;

  const date = stuDateEl.value || todayLocalYYYYMMDD();
  const rec = getStudentRec(date, currentStudentNumber);
  stuUnderEl.value = rec?.under ?? 0;
  stuOverEl.value  = rec?.over  ?? 0;
  stuServeEl.value = rec?.serve ?? 0;
}

if (stuDateEl){
  stuDateEl.addEventListener("change", ()=> loadStudentInputsForDate());
}

if (stuSaveBtn){
  stuSaveBtn.addEventListener("click", ()=>{
    if (currentStudentNumber == null) return;
    if (!stuDateEl) return;

    const date = stuDateEl.value || todayLocalYYYYMMDD();

    setStudentRec(
      date,
      currentStudentNumber,
      stuUnderEl ? stuUnderEl.value : 0,
      stuOverEl  ? stuOverEl.value  : 0,
      stuServeEl ? stuServeEl.value : 0
    );

    save();
    renderGrid();
    renderStudentModal();
  });
}

if (stuDeleteBtn){
  stuDeleteBtn.addEventListener("click", ()=>{
    if (currentStudentNumber == null) return;
    if (!stuDateEl) return;

    const date = stuDateEl.value || todayLocalYYYYMMDD();
    deleteStudentRec(date, currentStudentNumber);

    save();
    renderGrid();
    loadStudentInputsForDate();
    renderStudentModal();
  });
}

/* ---- ê·¸ë˜í”„ ë°ì´í„°(í•™ìƒ íŒì—… ê¸°ë¡ë§Œ ì‚¬ìš©) ---- */
function getSeriesForStudent(number, metric){
  const key = String(number);
  const dates = Object.keys(state.studentRecordsByDate).sort();
  const pts = [];

  for (const d of dates){
    const rec = state.studentRecordsByDate[d]?.[key];
    if (!rec) continue;

    const raw = Number(rec[metric] ?? 0);
    const value = Number.isFinite(raw) ? raw : 0;

    if (value === 0) continue; // 0ì€ ê¸°ë¡ ì•„ë‹˜
    pts.push({ date: d, value });
  }
  return pts;
}

function renderStudentModal(){
  if (currentStudentNumber == null) return;

  const metric = state.lastMetric || "under";
  const pts = getSeriesForStudent(currentStudentNumber, metric);

  renderKPI(currentStudentNumber);
  drawChart(pts, metric);

  if (chartHint){
    chartHint.textContent = `ê·¸ë˜í”„ í•­ëª©: ${metricLabel(metric)} (í•™ìƒë³„ íŒì—…ì—ì„œ ì €ì¥í•œ ê°’ë§Œ í‘œì‹œë©ë‹ˆë‹¤.)`;
  }
}

/* KPI: ìµœê³ ê¸°ë¡ + ê¸°ë¡ì¼ìˆ˜/ìµœê·¼ë‚ ì§œ */
function renderKPI(number){
  if (!kpiRow) return;

  const under = getSeriesForStudent(number, "under");
  const over  = getSeriesForStudent(number, "over");
  const serve = getSeriesForStudent(number, "serve");

  const best = (arr)=> arr.length ? Math.max(...arr.map(x=>x.value)) : 0;
  const count = (arr)=> arr.length;
  const lastDate = (arr)=> arr.length ? arr[arr.length-1].date : "-";

  kpiRow.innerHTML = `
    <div class="kpi">
      <div class="muted">ì–¸ë” ìµœê³ ê¸°ë¡</div>
      <b>${best(under)}</b>
      <div class="muted">ê¸°ë¡ ì¼ìˆ˜ ${count(under)} Â· ìµœê·¼ ${lastDate(under)}</div>
    </div>
    <div class="kpi">
      <div class="muted">ì˜¤ë²„ ìµœê³ ê¸°ë¡</div>
      <b>${best(over)}</b>
      <div class="muted">ê¸°ë¡ ì¼ìˆ˜ ${count(over)} Â· ìµœê·¼ ${lastDate(over)}</div>
    </div>
    <div class="kpi">
      <div class="muted">ì„œë¸Œ ìµœê³ ê¸°ë¡</div>
      <b>${best(serve)}</b>
      <div class="muted">ê¸°ë¡ ì¼ìˆ˜ ${count(serve)} Â· ìµœê·¼ ${lastDate(serve)}</div>
    </div>
  `;
}

/* =========================================================
   ê·¸ë˜í”„(Canvas)
========================================================= */
function drawChart(points, metric){
  if (!ctx || !chartCanvas) return;

  ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,chartCanvas.width, chartCanvas.height);

  if (!points || points.length < 2){
    ctx.fillStyle = "#666";
    ctx.font = "16px system-ui";
    ctx.fillText("ê¸°ë¡ì´ 2ê°œ ì´ìƒ ìˆì–´ì•¼ ê·¸ë˜í”„ê°€ ë‚˜ì™€ìš”. (í•™ìƒ íŒì—…ì—ì„œ ë‚ ì§œë³„ ì €ì¥)", 20, 60);
    return;
  }

  const padL = 54, padR = 16, padT = 24, padB = 44;
  const W = chartCanvas.width, H = chartCanvas.height;
  const w = W - padL - padR;
  const h = H - padT - padB;

  const vals = points.map(p=>p.value);
  const minV = Math.min(...vals);
  const maxV = Math.max(...vals);
  const span = (maxV - minV) || 1;

  ctx.strokeStyle = "#ddd";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, H-padB);
  ctx.lineTo(W-padR, H-padB);
  ctx.stroke();

  ctx.fillStyle = "#666";
  ctx.font = "12px system-ui";
  ctx.fillText(String(maxV), 12, padT+4);
  ctx.fillText(String(minV), 12, H-padB);

  ctx.fillStyle = "#111";
  ctx.font = "14px system-ui";
  ctx.fillText(`${metricLabel(metric)} ë³€í™”`, padL, 16);

  ctx.strokeStyle = "#111";
  ctx.lineWidth = 2;
  ctx.beginPath();
  points.forEach((p, i)=>{
    const x = padL + (i/(points.length-1)) * w;
    const y = padT + (1 - (p.value - minV)/span) * h;
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = "#111";
  points.forEach((p, i)=>{
    const x = padL + (i/(points.length-1)) * w;
    const y = padT + (1 - (p.value - minV)/span) * h;
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  });

  const first = points[0].date;
  const last  = points[points.length-1].date;
  ctx.fillStyle = "#666";
  ctx.font = "12px system-ui";
  ctx.fillText(first, padL, H-14);
  ctx.fillText(last, W-padR-90, H-14);
}

/* =========================================================
   TOP5 (ëª¨ë“  slot í•©ì‚° / ë‚¨ì—¬ ë¶„ë¦¬ / ë™ì ì í¬í•¨)
========================================================= */
function pickRecordsBucket(saved){
  // studentRecordsByDate ìš°ì„ , ì—†ìœ¼ë©´ ë‹¤ë¥¸ ë²„í‚·
  if (saved?.studentRecordsByDate) return saved.studentRecordsByDate;
  if (saved?.recordsByDate) return saved.recordsByDate;
  if (saved?.itemRecordsByDate) return saved.itemRecordsByDate;
  return {};
}

function isDefaultName(name){
  const t = String(name||"").trim();
  return /^í•™ìƒ\s*\d+$/i.test(t);
}

async function loadAllSlots(){
  const list = [];
  for (let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if (!k || !k.startsWith(STORAGE_PREFIX)) continue;
    try{
      const saved = JSON.parse(localStorage.getItem(k));
      if (saved) list.push(saved);
    }catch{}
  }

  if (practiceStatesRef){
    try{
      const snap = await practiceStatesRef.get();
      snap.forEach((doc) => {
        if (!doc.id.startsWith("practice_slot_")) return;
        const remote = doc.data()?.state;
        if (!remote) return;
        list.push(sanitizePracticeState(JSON.parse(JSON.stringify(remote))));
      });
    }catch(err){
      console.warn("[firebase] practice top5 load failed:", err);
    }
  }

  return list;
}

// ëª¨ë“  ìŠ¬ë¡¯ì—ì„œ numKeyë³„ name/gender/best(under/over/serve) ì§‘ê³„
async function buildAggregateBest(){
  const all = await loadAllSlots();
  const agg = new Map(); // numKey -> { numKey, name, gender, best:{under,over,serve} }

  for (const saved of all){
    const roster = Array.isArray(saved?.roster) ? saved.roster : [];
    const rosterMap = new Map();
    roster.forEach(s=>{
      const nk = String(s.number);
      const nm = String(s.name||"").trim();
      const gd = (s.gender === "F" ? "F" : "M");
      rosterMap.set(nk, { name:nm, gender:gd });
    });

    const bucket = pickRecordsBucket(saved);
    const dates = Object.keys(bucket||{});
    for (const d of dates){
      const day = bucket[d];
      if (!day) continue;

      for (const numKey of Object.keys(day)){
        const rec = day[numKey];
        if (!rec) continue;

        const u = Number(rec.under||0);
        const o = Number(rec.over||0);
        const s = Number(rec.serve||0);

        // ì „ë¶€ 0ì´ë©´ ìŠ¤í‚µ
        if ((u<=0) && (o<=0) && (s<=0)) continue;

        const fromRoster = rosterMap.get(numKey) || {};
        const nameFromSlot = fromRoster.name || `#${numKey}`;
        const genderFromSlot = fromRoster.gender || "M";

        if (!agg.has(numKey)){
          agg.set(numKey, {
            numKey,
            name: nameFromSlot,
            gender: genderFromSlot,
            best: { under:0, over:0, serve:0 }
          });
        }

        const cur = agg.get(numKey);

        // ì´ë¦„ì€ "í•™ìƒ1" ê°™ì€ ê¸°ë³¸ê°’ì´ë©´ ë” ì¢‹ì€ ì´ë¦„ìœ¼ë¡œ êµì²´
        if (isDefaultName(cur.name) && !isDefaultName(nameFromSlot)) cur.name = nameFromSlot;
        // genderëŠ” Fê°€ í•œ ë²ˆì´ë¼ë„ ë‚˜ì˜¤ë©´ Fë¡œ(ì‹¤ì œ ì—¬í•™ìƒì¸ë° Mìœ¼ë¡œ ë‚¨ì•„ìˆëŠ” ê²½ìš° ë³´ì •)
        if (cur.gender !== "F" && genderFromSlot === "F") cur.gender = "F";

        cur.best.under = Math.max(cur.best.under, Number.isFinite(u) ? u : 0);
        cur.best.over  = Math.max(cur.best.over,  Number.isFinite(o) ? o : 0);
        cur.best.serve = Math.max(cur.best.serve, Number.isFinite(s) ? s : 0);
      }
    }
  }

  return agg;
}

// limit(5) ê¸°ì¤€ + ë™ì ì í¬í•¨ + ë™ìˆœìœ„ ê³„ì‚°
function topWithTies(entries, limit){
  const arr = entries.filter(x=>x.best>0).sort((a,b)=> b.best - a.best);
  if (arr.length === 0) return [];

  const cutIndex = Math.min(limit-1, arr.length-1);
  const cutoff = arr[cutIndex].best;

  // cutoff ì´ìƒ ëª¨ë‘ í¬í•¨
  const included = arr.filter(x => x.best >= cutoff);

  // ë™ìˆœìœ„ ê³„ì‚°(1,2,2,4...)
  let prev = null;
  let rank = 0;
  arr.forEach((x, idx)=>{
    if (x.best !== prev){
      rank = idx + 1;
      prev = x.best;
    }
    x.rank = rank;
  });

  const includeSet = new Set(included.map(x=>x.numKey));
  return arr.filter(x=>includeSet.has(x.numKey));
}

function medal(rank){
  if (rank===1) return "ğŸ¥‡";
  if (rank===2) return "ğŸ¥ˆ";
  if (rank===3) return "ğŸ¥‰";
  return String(rank);
}

async function renderTop5AllSlots(){
  // itemSection ì•ˆì— mountê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ
  if (!topMount) return;

  const agg = await buildAggregateBest();
  const metrics = [
    { key:"under", label:"ì–¸ë”í•¸ë“œíŒ¨ìŠ¤" },
    { key:"over",  label:"ì˜¤ë²„í•¸ë“œíŒ¨ìŠ¤" },
    { key:"serve", label:"ì„œë¸Œ" },
  ];

  const LIMIT = 5;

  const blocks = metrics.map(m=>{
    const boys = [];
    const girls = [];

    for (const v of agg.values()){
      const best = v.best[m.key] || 0;
      if (best <= 0) continue;

      const row = { numKey:v.numKey, name:v.name, gender:v.gender, best };
      if (v.gender === "F") girls.push(row);
      else boys.push(row);
    }

    const boysTop  = topWithTies(boys, LIMIT);
    const girlsTop = topWithTies(girls, LIMIT);

    const listHtml = (rows, tone)=> {
      if (!rows.length) return `<div style="padding:14px;opacity:.75;text-align:center;">ê¸°ë¡ì´ ì—†ì–´ìš”</div>`;
      return rows.map(r=>`
        <div style="
          display:flex;align-items:center;justify-content:space-between;
          padding:10px 12px;border:1px solid rgba(0,0,0,.08);
          border-radius:14px;margin:8px 0;
          background:${tone==='male' ? 'linear-gradient(135deg, rgba(37,99,235,.12), rgba(6,182,212,.10))' : 'linear-gradient(135deg, rgba(244,63,94,.12), rgba(251,113,133,.10))'};
        ">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-size:22px;font-weight:950;min-width:44px;text-align:center;">${medal(r.rank)}</div>
            <div style="font-size:22px;font-weight:950;">${escapeHtml(r.name)}</div>
          </div>
          <div style="font-size:26px;font-weight:950;">${r.best}íšŒ</div>
        </div>
      `).join("");
    };

    return `
      <div style="margin:16px 0;padding:14px;border:1px solid rgba(0,0,0,.08);border-radius:16px;background:rgba(255,255,255,.7);">
        <div style="font-size:26px;font-weight:950;text-align:center;margin:2px 0 12px;">ğŸ† ${m.label} TOP5</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div style="border:1px solid rgba(37,99,235,.18);border-radius:16px;padding:12px;background:#fff;">
            <div style="font-size:18px;font-weight:950;text-align:center;margin-bottom:8px;">ğŸ‘¦ ë‚¨í•™ìƒ TOP5</div>
            ${listHtml(boysTop,'male')}
          </div>
          <div style="border:1px solid rgba(244,63,94,.18);border-radius:16px;padding:12px;background:#fff;">
            <div style="font-size:18px;font-weight:950;text-align:center;margin-bottom:8px;">ğŸ‘§ ì—¬í•™ìƒ TOP5</div>
            ${listHtml(girlsTop,'female')}
          </div>
        </div>
        <div style="opacity:.7;text-align:center;margin-top:10px;">â€» 5ë“±ê³¼ ë™ì ìëŠ” ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    `;
  }).join("");

  topMount.innerHTML = blocks;
}

if (topRefreshBtn){
  topRefreshBtn.addEventListener("click", ()=> { void renderTop5AllSlots(); });
}

/* =========================================================
   í•™ìƒ ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°(CSV): number,name,gender(ì˜µì…˜)
========================================================= */
if (importRosterBtn){
  importRosterBtn.addEventListener("click", ()=>{
    if (!rosterFile) return;
    rosterFile.value = "";
    rosterFile.click();
  });
}

if (rosterFile){
  rosterFile.addEventListener("change", async ()=>{
    const file = rosterFile.files?.[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length>0);
    if (lines.length===0) return;

    const head = lines[0].split(",").map(s=>s.trim().toLowerCase());
    const hasHeader = head.includes("number") && head.includes("name");

    let idxNumber = 0, idxName = 1, idxGender = 2;
    if (hasHeader){
      idxNumber = head.indexOf("number");
      idxName   = head.indexOf("name");
      idxGender = head.indexOf("gender"); // ì—†ìœ¼ë©´ -1
    }

    const start = hasHeader ? 1 : 0;
    const list = [];

    for (let i=start;i<lines.length;i++){
      const parts = lines[i].split(",").map(s=>s.trim());
      const number = Number(parts[idxNumber]);
      const name = (parts[idxName] ?? "").trim();
      if (!Number.isFinite(number) || !name) continue;

      const genderRaw = hasHeader
        ? (idxGender >= 0 ? (parts[idxGender] ?? "") : "")
        : (parts[2] ?? "");

      let gender = "M";
      const g = String(genderRaw).trim().toLowerCase();
      if (g === "f" || g === "female" || g.startsWith("ì—¬")) gender = "F";
      else if (g === "m" || g === "male" || g.startsWith("ë‚¨")) gender = "M";

      list.push({ number, name, gender });
    }

    const map = new Map(list.map(x=>[x.number, x]));
    state.roster = state.roster.map(stu => {
      if (!map.has(stu.number)) return stu;
      const row = map.get(stu.number);
      return {
        ...stu,
        number: stu.number,
        name: row.name,
        gender: row.gender || (stu.gender ?? "M"),
      };
    });

    save();
    renderGrid();

    // TOP5 í™”ë©´ì´ë©´ ê°±ì‹ 
    if (state.mode !== "student") renderTop5AllSlots();
  });
}

/* =========================================================
   ì „ì²´ ì´ˆê¸°í™”
========================================================= */
if (resetAllBtn){
  resetAllBtn.addEventListener("click", async ()=>{
    const ok = confirm("ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?\n(í•™ìƒëª…ë‹¨/ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤)");
    if (!ok) return;

    const fresh = sanitizePracticeState({
      mode: "student",
      roster: makeRoster30(),
      studentRecordsByDate: {},
      itemRecordsByDate: {},
      lastMetric: "under",
      meta: { school:"", grade:"", className:"" },
    });

    localStorage.setItem(KEY, JSON.stringify(fresh));
    if (practiceCloudRef){
      try{
        const payload = JSON.parse(JSON.stringify(fresh));
        await practiceCloudRef.set({
          state: payload,
          slot: SLOT,
          updatedBy: PRACTICE_CLIENT_ID,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      }catch(err){
        console.warn("[firebase] practice cloud reset failed:", err);
      }
    }
    location.reload();
  });
}

/* =========================================================
   í•™ìƒ ì¶”ê°€/ì‚­ì œ
========================================================= */
function makeStudent(n){
  return { number: n, name: `í•™ìƒ${n}`, gender:"M" };
}

if (addStudentBtn){
  addStudentBtn.addEventListener("click", () => {
    const nextNum = (state.roster?.length || 0) + 1;
    if (!state.roster) state.roster = [];
    state.roster.push(makeStudent(nextNum));
    save();
    renderGrid();
    if (state.mode !== "student") renderTop5AllSlots();
  });
}

if (removeStudentBtn){
  removeStudentBtn.addEventListener("click", () => {
    if (!state.roster || state.roster.length === 0) return;
    state.roster.pop();
    save();
    renderGrid();
    if (state.mode !== "student") renderTop5AllSlots();
  });
}

/* =========================================================
   ìµœì´ˆ ì‹¤í–‰
========================================================= */
renderGrid();
setMode(state.mode || "student");
void startPracticeCloudSync();
</script>

</body>
</html>
